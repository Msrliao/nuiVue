import{a as $}from"./apiClient-BboTgsdc.js";import{p as Q,d as B,u as E,a as Y,i as F,j as N,r,o as M,c as V,w as a,b as t,e as I,f as n,h as W,n as G,g as A,k as T,_ as j,s as L,q as Z,m as ee,F as te}from"./index-CWiALeIP.js";const q=Q("tableRow",{state:()=>({row:{}}),actions:{},getters:{}}),oe=B({__name:"table",emits:["edit"],setup(U,{expose:P,emit:_}){const h=_,c=E(),v=Y(),f=n(!1),u=n([]),l=n([]),w=q(),D=w.$subscribe((m,R)=>{console.log("变化详情：",m),console.log("最新状态：",R)});async function x(){f.value=!0;try{const m=await $.get("/warehouses");u.value=m,m.length>0&&m[0]&&(l.value=[m[0].id],w.row=m[0])}catch(m){c.error(m.message||"获取仓库数据失败")}f.value=!1}function C(){return[{type:"selection",multiple:!1},{title:"仓库名称",key:"ckmc",sorter:"default"},{title:"负责人",key:"fzr",sorter:"default"},{title:"联系电话",key:"lxdh"},{title:"备注",key:"bz"},{title:"创建时间",key:"created_at",sorter:"default"}]}const o=C(),e=[{label:"编辑",key:"edit"},{label:()=>W("span",{style:{color:"red"}},"删除"),key:"delete"}],s=n(null),g=n(!1),y=n(0),d=n(0),i=g,p=y,b=d;function z(m){m==="edit"&&s.value?h("edit",s.value):m==="delete"&&s.value&&v.warning({title:"确认删除",content:`确定要删除仓库"${s.value.ckmc}"吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await $.delete(`/warehouses/${s.value?.id}`),c.success("仓库删除成功"),X()}catch(R){c.error(R.message||"仓库删除失败")}}}),g.value=!1}function k(){g.value=!1,s.value=null}function S(m){return{onContextmenu:R=>{s.value=m,R.preventDefault(),g.value=!1,G().then(()=>{g.value=!0,y.value=R.clientX,d.value=R.clientY})},onClick:R=>{R.stopPropagation(),w.row=m,l.value=[m.id],s.value=m}}}function X(){x()}return P({refreshData:X}),F(()=>{x()}),N(()=>{D()}),(m,R)=>{const H=r("n-data-table"),J=r("n-dropdown"),O=r("n-flex");return M(),V(O,null,{default:a(()=>[t(H,{"checked-row-keys":l.value,"onUpdate:checkedRowKeys":R[0]||(R[0]=K=>l.value=K),columns:I(o),data:u.value,"row-props":S,loading:f.value,striped:"","row-key":K=>K.id},null,8,["checked-row-keys","columns","data","loading","row-key"]),t(J,{placement:"bottom-start",trigger:"manual",x:I(p),y:I(b),options:e,show:I(i),"on-clickoutside":k,onSelect:z},null,8,["x","y","show"])]),_:1})}}}),ae=B({__name:"addInfor",props:{show:{type:Boolean},editData:{}},emits:["close","refresh"],setup(U,{emit:P}){const _=U,h=P,c=n(null),v=n(_.show),f=n(!1),u=n({ckmc:"",fzr:"",lxdh:"",bz:""}),l=E(),w={ckmc:{required:!0,message:"请输入名称",trigger:"blur"}};function D(){c.value&&(u.value={id:"",ckmc:"",fzr:"",lxdh:"",bz:""},c.value.restoreValidation())}A(()=>_.show,o=>{v.value=o}),A(()=>_.editData,o=>{o&&(u.value={id:o.id||"",ckmc:o.ckmc||"",fzr:o.fzr||"",lxdh:o.lxdh||"",bz:o.bz||""})},{immediate:!0});function x(){v.value=!1,h("close"),D()}async function C(){if(c.value){f.value=!0;try{await c.value.validate();const o=u.value;(o.id?await $.put(`/warehouses/${o.id}`,o):await $.post("/warehouses",o)).code===200?l.success("操作成功!"):l.error("操作失败！"),x(),h("refresh")}catch(o){l.error(o.message||"操作失败！")}f.value=!1}}return F(()=>{}),N(()=>{}),(o,e)=>{const s=r("n-input"),g=r("n-form-item-gi"),y=r("n-grid"),d=r("n-button"),i=r("n-flex"),p=r("n-form"),b=r("n-card"),z=r("n-modal");return M(),V(z,{show:v.value,"onUpdate:show":e[4]||(e[4]=k=>v.value=k)},{default:a(()=>[t(b,{style:{"max-width":"600px"},title:"新建仓库",bordered:!1,size:"huge",role:"dialog","aria-modal":"true"},{default:a(()=>[t(p,{ref_key:"formRef",ref:c,model:u.value,rules:w,"label-placement":"left","label-width":"auto"},{default:a(()=>[t(y,{cols:"1 s:1 m:1 l:1 xl:1 2xl:1",responsive:"screen"},{default:a(()=>[t(g,{label:"仓库名称:",path:"ckmc"},{default:a(()=>[t(s,{value:u.value.ckmc,"onUpdate:value":e[0]||(e[0]=k=>u.value.ckmc=k),placeholder:"请输入仓库名称"},null,8,["value"])]),_:1}),t(g,{label:"负责人:",path:"fzr"},{default:a(()=>[t(s,{value:u.value.fzr,"onUpdate:value":e[1]||(e[1]=k=>u.value.fzr=k),placeholder:"请输入负责人"},null,8,["value"])]),_:1}),t(g,{label:"联系电话:",path:"lxdh"},{default:a(()=>[t(s,{value:u.value.lxdh,"onUpdate:value":e[2]||(e[2]=k=>u.value.lxdh=k),placeholder:"请输入联系电话"},null,8,["value"])]),_:1}),t(g,{span:24,label:"备注:",path:"bz",style:{width:"100%"}},{default:a(()=>[t(s,{value:u.value.bz,"onUpdate:value":e[3]||(e[3]=k=>u.value.bz=k),placeholder:"请输入备注",type:"textarea",autosize:{minRows:2,maxRows:3}},null,8,["value"])]),_:1})]),_:1}),t(i,{justify:"end"},{default:a(()=>[t(d,{"attr-type":"button",loading:f.value,type:"error",onClick:D},{default:a(()=>[...e[5]||(e[5]=[T(" 清空 ",-1)])]),_:1},8,["loading"]),t(d,{"attr-type":"button",loading:f.value,type:"success",onClick:C},{default:a(()=>[...e[6]||(e[6]=[T(" 保存 ",-1)])]),_:1},8,["loading"]),t(d,{"attr-type":"button",loading:f.value,type:"warning",onClick:x},{default:a(()=>[...e[7]||(e[7]=[T(" 取消 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show"])}}}),ne=j(ae,[["__scopeId","data-v-ee6f12dd"]]),le={class:"place-tree-container"},se=B({__name:"placeTree",emits:["edit","add"],setup(U,{expose:P,emit:_}){const h=_,c=n([]),v=n([]),{row:f}=L(q()),u=n(!1),l=Y(),w=E();A(()=>f.value,()=>{x()},{deep:!0});function D(i,p=null){return i.filter(b=>b.parent_id===p).map(b=>({label:b.position_name,key:b.id.toString(),children:D(i,b.id)}))}async function x(){u.value=!0;try{let i=[];f.value.id&&(i=await $.get(`/positions/warehouse/${f.value.id}`)),c.value=D(i),v.value=c.value.map(p=>p.key)}catch(i){console.error("获取仓位数据失败:",i)}u.value=!1}const C=n(!1),o=n(null),e=n(0),s=n(0);function g({option:i}){return{onClick(){},onContextmenu(p){console.log("右键点击:",i),o.value=i,p.preventDefault(),C.value=!1,G().then(()=>{C.value=!0,e.value=p.clientX,s.value=p.clientY})}}}const y=[{label:"添加",key:"add"},{label:"编辑",key:"edit"},{label:()=>W("span",{style:{color:"red"}},"删除"),key:"delete"}];function d(i){i==="add"&&o.value?h("add",o.value):i==="edit"&&o.value?h("edit",o.value):i==="delete"&&o.value&&l.warning({title:"确认删除",content:`确定要删除仓库"${o.value.label}"吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await $.delete(`/positions/${o.value?.key}`),w.success("仓库删除成功"),x()}catch(p){w.error(p.message||"仓库删除失败")}}}),C.value=!1}return F(()=>{x()}),N(()=>{}),P({fetchPositionData:x}),(i,p)=>{const b=r("n-tree"),z=r("n-dropdown"),k=r("n-spin"),S=r("n-space");return M(),V(S,{vertical:""},{default:a(()=>[t(k,{show:u.value},{default:a(()=>[Z("div",le,[t(b,{"block-line":"",data:c.value,"default-expanded-keys":v.value,"expand-on-click":"","node-props":g},null,8,["data","default-expanded-keys"])]),t(z,{trigger:"manual",placement:"bottom-start",show:C.value,options:y,x:e.value,y:s.value,onSelect:d},null,8,["show","x","y"])]),_:1},8,["show"])]),_:1})}}}),ue=j(se,[["__scopeId","data-v-37af42d7"]]),re=B({__name:"addPlace",props:{show:{type:Boolean},editData:{},addData:{}},emits:["close","refresh"],setup(U,{emit:P}){const _=U,h=P,{row:c}=L(q()),v=n(null),f=n(_.show),u=n(!1),l=n({id:null,warehouse_id:null,position_name:"",parent_id:null,description:""}),w=E(),D={position_name:{required:!0,message:"请输入名称",trigger:"blur"}};function x(){v.value&&(l.value={warehouse_id:null,position_name:"",parent_id:null,description:""},v.value.restoreValidation())}A(()=>_.show,e=>{f.value=e}),A(()=>_.editData,e=>{e&&(l.value={id:e.key,warehouse_id:c.value.id||null,position_name:e.label||"",description:""})},{immediate:!0}),A(()=>_.addData,e=>{e&&(l.value={warehouse_id:c.value.id,position_name:"",parent_id:e.key,description:""})},{immediate:!0});function C(){f.value=!1,h("close"),x()}async function o(){if(v.value){u.value=!0;try{if(await v.value.validate(),console.log("校验通过:",l.value),l.value.id){const e=await $.put(`/positions/${l.value.id}`,l.value);e&&e.code===200&&w.success("仓位更新成功"),C(),h("refresh")}else{console.log("创建仓位",l.value);const e=await $.post("/positions",l.value);e&&e.code===200&&w.success("仓位创建成功"),C(),h("refresh")}}catch(e){console.error("操作失败:",e),w.error(e.message||"操作失败")}u.value=!1}}return F(()=>{}),N(()=>{}),(e,s)=>{const g=r("n-input"),y=r("n-form-item-gi"),d=r("n-grid"),i=r("n-button"),p=r("n-flex"),b=r("n-form"),z=r("n-card"),k=r("n-modal");return M(),V(k,{show:f.value,"onUpdate:show":s[1]||(s[1]=S=>f.value=S)},{default:a(()=>[t(z,{style:{"max-width":"600px"},title:"新建仓位",bordered:!1,size:"huge",role:"dialog","aria-modal":"true"},{default:a(()=>[t(b,{ref_key:"formRef",ref:v,model:l.value,rules:D,"label-placement":"left","label-width":"auto"},{default:a(()=>[t(d,{cols:"1 s:1 m:1 l:1 xl:1 2xl:1",responsive:"screen"},{default:a(()=>[t(y,{label:"仓库名称:",path:"position_name"},{default:a(()=>[t(g,{value:l.value.position_name,"onUpdate:value":s[0]||(s[0]=S=>l.value.position_name=S),placeholder:"请输入仓库名称"},null,8,["value"])]),_:1})]),_:1}),t(p,{justify:"end"},{default:a(()=>[t(i,{"attr-type":"button",loading:u.value,type:"success",onClick:o},{default:a(()=>[...s[2]||(s[2]=[T(" 保存 ",-1)])]),_:1},8,["loading"]),t(i,{"attr-type":"button",type:"warning",onClick:C},{default:a(()=>[...s[3]||(s[3]=[T(" 取消 ",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show"])}}}),ie=j(re,[["__scopeId","data-v-70db036a"]]),de=B({__name:"index",setup(U){const P=E(),{row:_}=L(q()),h=n(!1),c=n(!1),v=n(null),f=n(null),u=n(null),l=n(null),w=n(null);function D(){_.value?c.value=!0:P.error("请先选择要添加到哪个库房")}function x(){h.value=!0}function C(){console.log("刷新仓库数据"),l.value&&l.value.refreshData()}function o(){console.log("刷新仓位树形框数据"),w.value&&w.value.fetchPositionData()}function e(y){v.value=y,h.value=!0}function s(y){f.value=y,c.value=!0}function g(y){u.value=y,c.value=!0}return(y,d)=>{const i=r("n-button"),p=r("n-flex"),b=r("n-card");return M(),ee(te,null,[t(p,null,{default:a(()=>[t(i,{onClick:d[0]||(d[0]=z=>x())},{default:a(()=>[...d[4]||(d[4]=[T(" 添加仓库 ",-1)])]),_:1}),t(i,{onClick:d[1]||(d[1]=z=>D())},{default:a(()=>[...d[5]||(d[5]=[T(" 添加库位 ",-1)])]),_:1})]),_:1}),t(oe,{ref_key:"tableRef",ref:l,onEdit:e},null,512),t(b,{title:I(_).ckmc?`仓库：${I(_).ckmc}`:"未选择仓库"},{default:a(()=>[t(ue,{ref_key:"placeTreeRef",ref:w,onEdit:s,onAdd:g},null,512)]),_:1},8,["title"]),t(p,null,{default:a(()=>[t(ne,{show:h.value,"edit-data":v.value,onClose:d[2]||(d[2]=z=>h.value=!1),onRefresh:C},null,8,["show","edit-data"])]),_:1}),t(p,null,{default:a(()=>[t(ie,{show:c.value,"edit-data":f.value,"add-data":u.value,onClose:d[3]||(d[3]=z=>c.value=!1),onRefresh:o},null,8,["show","edit-data","add-data"])]),_:1})],64)}}}),pe=j(de,[["__scopeId","data-v-565be1b6"]]);export{pe as default};
